name: Deploy via LFTP (Force Upload)

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: Package & Force Upload
    runs-on: ubuntu-latest

    steps:
    # 1. AMBIL KODE
    - name: üöö Get latest code
      uses: actions/checkout@v4

    # 2. SETUP LINGKUNGAN
    - name: üêò Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, bcmath, intl

    - name: üì¶ Install Composer
      run: composer install --no-dev --optimize-autoloader --prefer-dist

    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # 3. BUILD ASSETS
    - name: üî® Build Frontend
      run: |
        npm ci
        npm run build

    # 4. BUAT .ENV
    - name: üîë Create .env file
      run: |
        cat <<'EOF' > .env
        ${{ secrets.ENV_FILE }}
        EOF

    # 5. PACKAGING (MEMBUAT ZIP)
    - name: üóúÔ∏è Prepare ZIP Package
      run: |
        mkdir -p deploy_package/core
        mkdir -p deploy_package/public
        
        # Copy Core
        rsync -av --exclude='deploy_package' --exclude='.git' --exclude='node_modules' --exclude='public' . deploy_package/core/
        
        # Copy Public Assets
        cp -r public/* deploy_package/public/
        
        # Pindahkan Manifest
        mkdir -p deploy_package/core/public/build
        cp public/build/manifest.json deploy_package/core/public/build/
        rm deploy_package/public/build/manifest.json
        
        # Hapus index.php
        rm deploy_package/public/index.php

        # ZIP
        cd deploy_package
        zip -r ../artifact.zip .
        cd ..

    # 6. PERSIAPAN FOLDER UPLOAD
    - name: üìÇ Prepare Final Upload Folder
      run: |
        mkdir final_upload
        mv artifact.zip final_upload/
        
        # BUAT SCRIPT DEPLOY.PHP OTOMATIS
        cat <<'EOF' > final_upload/deploy.php
        <?php
        ini_set('display_errors', 1);
        error_reporting(E_ALL);

        if (($_GET['token'] ?? '') !== 'ALVADEV_SECRET_KEY_2025') {
            die('ACCESS DENIED');
        }

        $zipFile = __DIR__ . '/artifact.zip';
        $extractPath = __DIR__ . '/temp_unzip';
        
        // PASTIIN PATH INI BENAR
        $targetCore = realpath(__DIR__ . '/../../repositories/portofolio_core');
        $targetPublic = __DIR__;

        echo "<h1>üöÄ Memulai Force Update...</h1>";
        
        if (!file_exists($zipFile)) die("‚ùå ZIP Kosong.");
        if (!$targetCore) die("‚ùå Target Core Tidak Ditemukan.");

        $zip = new ZipArchive;
        if ($zip->open($zipFile) === TRUE) {
            
            // Bersihkan temp lama
            if (is_dir($extractPath)) recursiveDelete($extractPath);
            mkdir($extractPath, 0755, true);
            
            // Ekstrak
            $zip->extractTo($extractPath);
            $zip->close();

            // UPDATE CORE
            echo "üì¶ Updating Core...<br>";
            smartCopy($extractPath . '/core', $targetCore);

            // UPDATE PUBLIC
            echo "üåç Updating Public Assets...<br>";
            smartCopy($extractPath . '/public', $targetPublic);

            // CLEAN UP
            recursiveDelete($extractPath);
            unlink($zipFile);
            unlink(__FILE__); // Self destruct
            
            echo "<h2>‚úÖ UPDATE BERHASIL!</h2>";
        } else {
            die("‚ùå Gagal Unzip.");
        }

        function smartCopy($src, $dst) {
            $dir = opendir($src);
            @mkdir($dst);
            while (false !== ($file = readdir($dir))) {
                if (($file != '.') && ($file != '..')) {
                    $srcFile = $source . '/' . $file;
                    $dstFile = $dest . '/' . $file;
                    if (is_dir($srcFile)) {
                        smartCopy($srcFile, $dstFile);
                    } else {
                        copy($srcFile, $dstFile);
                        touch($dstFile, filemtime($srcFile)); // Update timestamp
                    }
                }
            }
            closedir($dir);
        }

        function recursiveDelete($dir) {
            if (!is_dir($dir)) return;
            $files = array_diff(scandir($dir), array('.', '..'));
            foreach ($files as $file) {
                (is_dir("$dir/$file")) ? recursiveDelete("$dir/$file") : unlink("$dir/$file");
            }
            return rmdir($dir);
        }
        EOF

        # DEBUG: BUKTIKAN FILE ADA
        echo "Isi folder final_upload:"
        ls -la final_upload/

    # 7. UPLOAD MENGGUNAKAN LFTP (SOLUSI INTI)
    - name: üöÄ Force Upload via LFTP
      run: |
        # Install LFTP
        sudo apt-get update
        sudo apt-get install -y lftp

        # Upload Brutal (Mirroring)
        # Perintah ini memaksa isi folder 'final_upload' masuk ke 'public_html/portfolio'
        lftp -e "set ssl:verify-certificate no; open ${{ secrets.FTP_SERVER }}; user ${{ secrets.FTP_USERNAME }} ${{ secrets.FTP_PASSWORD }}; mirror -R -v final_upload/ public_html/portfolio/; bye"

    # 8. TRIGGER DEPLOY
    - name: üí• Trigger Deployment
      run: |
        echo "Menunggu sebentar agar file stabil..."
        sleep 5
        curl -s "https://portfolio.alvadev.cloud/deploy.php?token=ALVADEV_SECRET_KEY_2025"