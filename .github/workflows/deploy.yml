name: Deploy Laravel Inertia (Split Move Strategy)

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    steps:
    # ------------------------------------------------------------------
    # BUILD STEP
    # ------------------------------------------------------------------
    - name: ðŸšš Get latest code
      uses: actions/checkout@v4

    - name: ðŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, bcmath, intl

    - name: ðŸ“¦ Install Composer Dependencies
      run: composer install --no-dev --optimize-autoloader --prefer-dist

    - name: ðŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ðŸ”¨ Build Frontend Assets
      run: |
        npm ci
        npm run build
        
    - name: ðŸ”‘ Create .env file
      run: |
        echo "${{ secrets.ENV_FILE }}" > .env

    # ------------------------------------------------------------------
    # FASE 1: UPLOAD PUBLIC ASSETS (Hanya CSS/JS/Images)
    # Tujuan: public_html/portfolio
    # ------------------------------------------------------------------
    - name: ðŸš€ Upload Assets to Public (No Manifest)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: public/
        server-dir: public_html/portfolio/
        exclude: |
          index.php             # JANGAN TIMPA index.php custom
          build/manifest.json   # <--- FITUR UTAMA: Manifest tidak di-upload ke sini (Dipindahkan)
          .htaccess
          hot
          storage
          robots.txt

    # ------------------------------------------------------------------
    # FASE 2: UPLOAD CORE LARAVEL
    # Tujuan: repositories/portofolio_core
    # ------------------------------------------------------------------
    - name: ðŸš€ Upload Core Files
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        server-dir: repositories/portofolio_core/
        exclude: |
          **/.git*
          **/.git*/**
          node_modules/**
          public/** # Exclude public agar bersih
          tests/**
          storage/logs/**
          storage/framework/**
          storage/app/**
          .editorconfig
          .styleci.yml

    # ------------------------------------------------------------------
    # FASE 3: UPLOAD MANIFEST KE CORE (Hanya Manifest)
    # Tujuan: repositories/portofolio_core/public/build
    # ------------------------------------------------------------------
    - name: ðŸš€ Move Manifest to Core
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: public/build/
        server-dir: repositories/portofolio_core/public/build/
        exclude: |
          assets/** # <--- FITUR UTAMA: CSS/JS tidak ikut ke Core (Hemat Space)