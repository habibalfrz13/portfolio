name: Deploy via ZIP (Split Structure)

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: Package & Ship
    runs-on: ubuntu-latest

    steps:
    - name: ğŸšš Get latest code
      uses: actions/checkout@v4

    - name: ğŸ˜ Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, bcmath, intl

    - name: ğŸ“¦ Install Composer
      run: composer install --no-dev --optimize-autoloader --prefer-dist

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ğŸ”¨ Build Frontend
      run: |
        npm ci
        npm run build

    - name: ğŸ”‘ Create .env file
      run: |
        cat <<'EOF' > .env
        ${{ secrets.ENV_FILE }}
        EOF

    # --- BAGIAN PENTING: PACKAGING ---
    - name: ğŸ—œï¸ Prepare & Zip
      run: |
        # 1. Buat folder penampung
        mkdir -p deploy_package/core
        mkdir -p deploy_package/public
        
        # 2. Masukkan file CORE (Exclude public & node_modules)
        rsync -av --exclude='deploy_package' --exclude='.git' --exclude='node_modules' --exclude='public' . deploy_package/core/
        
        # 3. Masukkan file PUBLIC (CSS/JS)
        cp -r public/* deploy_package/public/
        
        # 4. MANIPULASI MANIFEST (PINDAHKAN DARI PUBLIC KE CORE)
        # Buat folder tujuan di core
        mkdir -p deploy_package/core/public/build
        # Copy manifest ke core
        cp public/build/manifest.json deploy_package/core/public/build/
        # Hapus manifest dari paket public (agar tidak ada di public_html)
        rm deploy_package/public/build/manifest.json
        
        # 5. AMANKAN INDEX.PHP
        # Hapus index.php dari paket public (agar index custom server tidak tertimpa)
        rm deploy_package/public/index.php

        # 6. ZIP
        cd deploy_package
        zip -r ../artifact.zip .
        cd ..

    # --- UPLOAD ZIP & DEPLOY SCRIPT ---
    - name: ğŸš€ Upload ZIP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./
        server-dir: public_html/portfolio/
        # Kita upload ZIP dan Script PHP-nya saja
        include: |
          artifact.zip
          public/deploy.php
        exclude: |
          **

    # --- TRIGGER EKSEKUSI ---
    - name: ğŸ’¥ Trigger Extraction
      run: |
        # GANTI TOKEN SESUAI YANG ADA DI FILE deploy.php
        curl -s "https://portfolio.alvadev.cloud/deploy.php?token=ALVADEV_SECRET_KEY_2025"